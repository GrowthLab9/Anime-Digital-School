import { PRODUCTS, CONFIG, MESSAGES } from './config.js';

export class BotHandler {
  constructor(bot, env) {
    this.bot = bot;
    this.env = env;
  }

  // --- 1. HANDLE PESAN TEXT ---
  async handleMessage(msg) {
    const chatId = msg.chat.id;
    const type = msg.chat.type;
    const text = msg.text || "";
    const user = msg.from;

    // A. Logika GRUP (Moderasi)
    if (type === "group" || type === "supergroup") {
      // Auto Welcome
      if (msg.new_chat_members) {
        return this.bot.sendMessage(chatId, MESSAGES.welcome(msg.new_chat_members[0].first_name));
      }

      // Admin Bypass (Admin bebas kirim link/toxic)
      if (user.id.toString() === this.env.ADMIN_ID) return;

      // Anti Link
      const hasLink = msg.entities?.some(e => e.type === "url" || e.type === "text_link");
      if (hasLink && !text.includes(CONFIG.official_link)) {
        await this.bot.deleteMessage(chatId, msg.message_id);
        return;
      }

      // Anti Toxic
      if (CONFIG.bad_words.some(word => text.toLowerCase().includes(word))) {
        await this.bot.deleteMessage(chatId, msg.message_id);
        await this.bot.sendMessage(chatId, MESSAGES.toxic_warning(user.first_name));
        return;
      }
    }

    // B. Logika PRIVATE / COMMANDS
    if (text === "/start") return this.sendMainMenu(chatId, user.first_name);
    
    // Fitur Broadcast (Hanya Admin)
    if (text.startsWith("/broadcast ") && user.id.toString() === this.env.ADMIN_ID) {
      // Implementasi broadcast sederhana bisa ditambahkan disini (butuh database user)
      return this.bot.sendMessage(chatId, "ğŸ“¢ Fitur broadcast siap dikonfigurasi.");
    }
  }

  // --- 2. HANDLE TOMBOL (CALLBACK) ---
  async handleCallback(query) {
    const chatId = query.message.chat.id;
    const msgId = query.message.message_id;
    const data = query.data;

    await this.bot.answerCallback(query.id);

    if (data === "menu_home") return this.sendMainMenu(chatId, "Sensei");
    if (data === "menu_katalog") return this.sendKatalog(chatId, msgId);
    if (data === "menu_bayar") return this.bot.sendMessage(chatId, MESSAGES.payment);

    // Cek apakah data adalah ID Produk
    if (PRODUCTS[data]) {
      return this.sendProductDetail(chatId, msgId, data);
    }
  }

  // --- 3. FUNGSI PEMBANTU TAMPILAN ---
  async sendMainMenu(chatId, name) {
    const kb = {
      inline_keyboard: [
        [{ text: "ğŸ“š Katalog Ebook", callback_data: "menu_katalog" }],
        [{ text: "ğŸ’³ Info Bayar", callback_data: "menu_bayar" }, { text: "ğŸ“ Admin", url: `https://t.me/${CONFIG.admin_username}` }],
        [{ text: "ğŸ‘¥ Join Komunitas", url: `https://${CONFIG.official_link}` }]
      ]
    };
    // Cek apakah ini edit atau pesan baru (logic sederhana: pesan baru)
    await this.bot.sendMessage(chatId, MESSAGES.welcome(name), kb);
  }

  async sendKatalog(chatId, msgId) {
    const text = "ğŸ“– *DAFTAR MATERI PELAJARAN*\nPilih materi yang ingin kamu pelajari:";
    // Auto-generate tombol dari config.js
    const buttons = Object.keys(PRODUCTS).map(key => ([{ text: PRODUCTS[key].title, callback_data: key }]));
    buttons.push([{ text: "ğŸ”™ Menu Utama", callback_data: "menu_home" }]);

    await this.bot.editMessage(chatId, msgId, text, { inline_keyboard: buttons });
  }

  async sendProductDetail(chatId, msgId, productId) {
    const p = PRODUCTS[productId];
    const text = `ğŸ“‚ *DETAIL PRODUK*\n\n` +
                 `ğŸ· *Judul:* ${p.title}\n` +
                 `ğŸ’° *Harga:* ${p.price}\n\n` +
                 `ğŸ“ *Deskripsi:*\n${p.desc}\n\n` +
                 `_Klik Beli untuk mendapatkan invoice._`;
    
    const kb = {
      inline_keyboard: [
        [{ text: "ğŸ›’ Beli Sekarang", callback_data: "menu_bayar" }],
        [{ text: "ğŸ”™ Kembali", callback_data: "menu_katalog" }]
      ]
    };
    await this.bot.editMessage(chatId, msgId, text, kb);
  }
}
